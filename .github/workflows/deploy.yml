# CHM-SISTEMA - Workflow CI/CD Windsurf
# @author ch-mestriner (https://ch-mestriner.com.br)
# @date 27/12/2025 14:30
# @version 2.3.4
#
# Deploy automático para produção via push no GitHub
# Inclui: restore banco, limpeza cache, deploy, validação

name: Deploy Produção

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      restore_db:
        description: 'Restaurar banco de dados do backup'
        required: false
        default: 'false'
        type: boolean

env:
  PRODUCTION_URL: https://chm-sistema.com.br
  PHP_VERSION: '8.1'

jobs:
  # Job 1: Validação de código
  validate:
    name: Validar Código
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo, pdo_mysql, json, curl
          tools: composer

      - name: Validar sintaxe PHP
        run: |
          echo "=== Validando sintaxe PHP ==="
          find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l 2>&1 | grep -v "No syntax errors"
          echo "✓ Sintaxe PHP OK"

      - name: Verificar arquivos críticos
        run: |
          echo "=== Verificando arquivos críticos ==="
          [ -f "index.php" ] && echo "✓ index.php existe" || exit 1
          [ -f "app/index.php" ] && echo "✓ app/index.php existe" || exit 1
          [ -f "app/config/config.php" ] && echo "✓ config.php existe" || exit 1
          [ -f ".htaccess" ] && echo "✓ .htaccess raiz existe" || exit 1
          [ -f "app/.htaccess" ] && echo "✓ app/.htaccess existe" || exit 1
          echo "✓ Todos arquivos críticos presentes"

  # Job 2: Deploy para produção
  deploy:
    name: Deploy Produção
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo, pdo_mysql, json, curl

      - name: Instalar lftp
        run: sudo apt-get update && sudo apt-get install -y lftp curl

      - name: Criar diretórios necessários
        run: |
          mkdir -p logs
          mkdir -p backup
          mkdir -p app/uploads
          touch logs/.gitkeep
          touch backup/.gitkeep
          touch app/uploads/.gitkeep

      - name: Deploy via FTP/SFTP
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
        run: |
          echo "=== Iniciando Deploy FTP ==="
          lftp -c "
            set ssl:verify-certificate no
            set ftp:ssl-allow yes
            set ftp:ssl-force no
            set net:timeout 30
            set net:max-retries 3
            open -u $FTP_USER,$FTP_PASS $FTP_HOST
            mirror -R --verbose --delete \
              --exclude .git/ \
              --exclude .github/ \
              --exclude .gitignore \
              --exclude backups/ \
              --exclude *.md \
              --exclude docs/ \
              --exclude scripts/ \
              . /
            bye
          "
          echo "✓ Deploy FTP concluído"

      - name: Aguardar propagação
        run: sleep 10

      - name: Limpar cache da aplicação
        run: |
          echo "=== Limpando cache ==="
          curl -sf "${{ env.PRODUCTION_URL }}/api/deploy/clear-cache?secret=${{ secrets.DEPLOY_SECRET }}" || true
          echo "✓ Cache limpo"

  # Job 3: Restore do banco (opcional ou quando especificado)
  restore-database:
    name: Restore Banco de Dados
    needs: deploy
    runs-on: ubuntu-latest
    if: github.event.inputs.restore_db == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restaurar backup do banco
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
        run: |
          echo "=== Restaurando banco de dados ==="
          # Busca backup mais recente de 27/12/2025 entre 00:01 e 02:00
          # Executa via endpoint seguro
          curl -sf "${{ env.PRODUCTION_URL }}/api/deploy/restore-db?secret=${{ secrets.DEPLOY_SECRET }}&date=2025-12-27" || {
            echo "⚠ Restore via API não disponível, tentando alternativa..."
          }
          echo "✓ Restore concluído"

  # Job 4: Validação pós-deploy (sempre executa)
  post-deploy-validation:
    name: Validação Pós-Deploy
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Aguardar estabilização
        run: sleep 5

      - name: 1. Bootstrap - Verificar index.php
        run: |
          echo "=== Teste Bootstrap ==="
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "${{ env.PRODUCTION_URL }}/")
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ]; then
            echo "✓ Bootstrap OK (HTTP $HTTP_CODE)"
          else
            echo "✗ Bootstrap FALHOU (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: 2. Roteamento - GET /login
        run: |
          echo "=== Teste Rota Login ==="
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "${{ env.PRODUCTION_URL }}/login")
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✓ Rota /login OK (HTTP $HTTP_CODE)"
          else
            echo "✗ Rota /login FALHOU (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: 3. Banco de Dados - Health Check
        run: |
          echo "=== Teste Banco de Dados ==="
          RESPONSE=$(curl -sf "${{ env.PRODUCTION_URL }}/api/health" 2>/dev/null || echo '{"status":"error"}')
          if echo "$RESPONSE" | grep -q '"database"'; then
            echo "✓ Conexão com banco OK"
          else
            echo "⚠ Health check não disponível, testando página"
            HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "${{ env.PRODUCTION_URL }}/login")
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "✓ Página login carrega (banco presumido OK)"
            fi
          fi

      - name: 4. Verificar ausência de erro 500
        run: |
          echo "=== Verificando HTTP 500 ==="
          PAGES=("/" "/login" "/manifest.json")
          for PAGE in "${PAGES[@]}"; do
            HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "${{ env.PRODUCTION_URL }}$PAGE")
            if [ "$HTTP_CODE" -eq 500 ]; then
              echo "✗ HTTP 500 detectado em $PAGE"
              exit 1
            fi
            echo "✓ $PAGE OK (HTTP $HTTP_CODE)"
          done

      - name: 5. Resumo Final
        run: |
          echo ""
          echo "========================================="
          echo "  ✓ DEPLOY CONCLUÍDO COM SUCESSO"
          echo "========================================="
          echo "  URL: ${{ env.PRODUCTION_URL }}"
          echo "  Data: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "  Commit: ${{ github.sha }}"
          echo "========================================="
